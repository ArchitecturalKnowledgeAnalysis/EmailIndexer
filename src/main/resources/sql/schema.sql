CREATE TABLE EMAIL (
    MESSAGE_ID VARCHAR(255) PRIMARY KEY,
    SUBJECT VARCHAR(1024),
    IN_REPLY_TO VARCHAR(255),
    SENT_FROM VARCHAR(255),
    DATE TIMESTAMP WITH TIME ZONE,
    BODY LONGTEXT,
    HIDDEN BOOL NOT NULL DEFAULT FALSE
);
CREATE INDEX IDX_EMAIL_REPLY ON EMAIL(IN_REPLY_TO);
CREATE INDEX IDX_EMAIL_DATE ON EMAIL(DATE);

/* Tags are simply defined as some short text attached to an email. */
CREATE TABLE EMAIL_TAG (
    MESSAGE_ID VARCHAR(255) NOT NULL REFERENCES EMAIL(MESSAGE_ID)
        ON UPDATE CASCADE ON DELETE CASCADE,
    TAG VARCHAR(255) NOT NULL,
    PRIMARY KEY (MESSAGE_ID, TAG)
);
CREATE INDEX IDX_EMAIL_TAG ON EMAIL_TAG(TAG);

/* Utility tables to record all changes made to the dataset. Each mutation should affect one or more emails. */
CREATE TABLE MUTATION (
    ID BIGINT PRIMARY KEY AUTO_INCREMENT,
    DESCRIPTION LONGTEXT NOT NULL,
    PERFORMED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP(0)
);
CREATE TABLE MUTATION_EMAIL (
    MUTATION_ID BIGINT NOT NULL REFERENCES MUTATION (ID)
        ON UPDATE CASCADE ON DELETE CASCADE,
    MESSAGE_ID VARCHAR(255) NOT NULL REFERENCES EMAIL(MESSAGE_ID)
        ON UPDATE CASCADE ON DELETE CASCADE,
    PRIMARY KEY (MUTATION_ID, MESSAGE_ID)
);